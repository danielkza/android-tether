#!/usr/bin/bash
set -x

# Set path to adb binary
adb="/home/vmm/dev/opt/android-sdk-linux/platform-tools/adb"

# Enable Wi-Fi
$adb shell svc wifi enable

# Set MAC address for RNDIS interface
#$adb shell 'echo "AA:BB:CC:DD:EE:FF" > /sys/class/android_usb/f_rndis/ethaddr'

# Enable USB tethering
$adb shell setprop persist.sys.usb.config rndis,adb

# Device is unavailable for 1 sec.
sleep 2

# Set iptables rules
# Got these strings from classes.dex inside tethering apk
$adb shell iptables -A POSTROUTING -s 192.168.42.0/24 -j MASQUERADE -t nat
$adb shell iptables -A FORWARD -j ACCEPT -i wlan0  -o rndis0
$adb shell iptables -A FORWARD -j ACCEPT -i ccmni0 -o rndis0
$adb shell iptables -A FORWARD -j ACCEPT -i ccmni1 -o rndis0
$adb shell iptables -A FORWARD -j ACCEPT -i ccmni2 -o rndis0
$adb shell iptables -A FORWARD -j ACCEPT -i rndis0 -o wlan0
$adb shell iptables -A FORWARD -j ACCEPT -i rndis0 -o ccmni0
$adb shell iptables -A FORWARD -j ACCEPT -i rndis0 -o ccmni1
$adb shell iptables -A FORWARD -j ACCEPT -i rndis0 -o ccmni2

# Configure RNDIS interface
$adb shell ip addr add 192.168.42.129/24 dev rndis0
$adb shell ip link set rndis0 up

# Apply iptables rules
$adb shell iptables -P FORWARD ACCEPT

# Enable IP forwarding
$adb shell 'echo 1 > /proc/sys/net/ipv4/ip_forward'
